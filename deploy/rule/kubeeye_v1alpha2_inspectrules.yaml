apiVersion: kubeeye.kubesphere.io/v1alpha2
kind: InspectRule
metadata:
  labels:
    app.kubernetes.io/name: inspectrule
    app.kubernetes.io/instance: inspectrule-sample
    app.kubernetes.io/part-of: kubeeye
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/created-by: kubeeye
    kubeeye.kubesphere.io/rule-tag: kubeeye_workloads_rego
  name: inspect-rule-sample
  namespace: kubeeye-system
spec:
  systemd:
    - name: docker
      rule: docker = "active"
    - name: etcd
      rule: etcd = "active"
      nodeName: master
  sysctl:
    - name: net.ipv4.ip_forward
      rule: net.ipv4.ip_forward = 1
  fileChange:
    - name: kubelet-config
      path: /var/lib/kubelet/config.yaml
  opas:
    - module: kubeeye_workloads_rego
      name: imagePullPolicyRule
      rule: |-
        package kubeeye_workloads_rego

        deny[msg] {
            resource := input
            type := resource.Object.kind
            resourcename := resource.Object.metadata.name
            resourcenamespace := resource.Object.metadata.namespace
            type == "Pod"
            level := "warning"

            PodimagePullPolicyRule(resource)

            msg := {
                "Name": sprintf("%v", [resourcename]),
                "Namespace": sprintf("%v", [resourcenamespace]),
                "Type": sprintf("%v", [type]),
                "Level": sprintf("%v", [level]),
                "Message": "ImagePullPolicyNotAlways"
            }
        }

        PodimagePullPolicyRule(resource) {
            imagePullPolicy := resource.Object.spec.containers[_].imagePullPolicy
            imagePullPolicy != "Always"
        }

        deny[msg] {
            resource := input
            type := resource.Object.kind
            resourcename := resource.Object.metadata.name
            resourcenamespace := resource.Object.metadata.namespace
            workloadsType := {"Deployment","ReplicaSet","DaemonSet","StatefulSet","Job"}
            workloadsType[type]
            level := "warning"

            workloadsimagePullPolicyRule(resource)

            msg := {
                "Name": sprintf("%v", [resourcename]),
                "Namespace": sprintf("%v", [resourcenamespace]),
                "Type": sprintf("%v", [type]),
                "Level": sprintf("%v", [level]),
                "Message": "ImagePullPolicyNotAlways"
            }
        }

        workloadsimagePullPolicyRule(resource) {
            imagePullPolicy := resource.Object.spec.template.spec.containers[_].imagePullPolicy
            imagePullPolicy != "Always"
        }

        deny[msg] {
            resource := input
            type := resource.Object.kind
            resourcename := resource.Object.metadata.name
            resourcenamespace := resource.Object.metadata.namespace
            type == "CronJob"
            level := "warning"

            CronJobimagePullPolicyRule(resource)

            msg := {
                "Name": sprintf("%v", [resourcename]),
                "Namespace": sprintf("%v", [resourcenamespace]),
                "Type": sprintf("%v", [type]),
                "Level": sprintf("%v", [level]),
                "Message": "ImagePullPolicyNotAlways"
            }
        }

        CronJobimagePullPolicyRule(resource) {
            imagePullPolicy := resource.Object.spec.jobTemplate.spec.template.spec.containers[_].imagePullPolicy
            imagePullPolicy != "Always"
        }